#!/usr/bin/env bash
set -e

BASE=/mnt/shares
INDEX=${BASE}/.index.txt
INDEXTMP=${INDEX}.tmp
INDEXTMP2=${INDEXTMP}2

# NOTE when serving with nginx, ensure the location has gzip enabled for a 10x
# boost

cd $BASE
find . -type f -not -path '*/.*' > ${INDEXTMP}

# prepend line count so search engine can show progress
cat ${INDEXTMP} | wc -l > ${INDEXTMP2}
cat ${INDEXTMP} >> ${INDEXTMP2}
mv ${INDEXTMP2} ${INDEX}
rm ${INDEXTMP}
chown www-data:www-data ${INDEX}
